% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/filter_time.R
\name{filter_time}
\alias{filter_time}
\title{Filter fossil occurrences by time}
\usage{
filter_time(
  occdf,
  min_ma = "min_ma",
  max_ma = "max_ma",
  bins = NULL,
  interval_name = "interval_name",
  youngest_bin = NULL,
  oldest_bin = NULL,
  min_age = NULL,
  max_age = NULL,
  uncertainty = NULL,
  n_bins = 1,
  retain.taxa = FALSE,
  taxa = NULL
)
}
\arguments{
\item{occdf}{\code{data.frame}. A \code{data.frame} of the fossil occurrences you wish
to filter. This \code{data.frame} must contain at least two columns, maximum
occurrence age and minimum occurrence age (see \code{max_ma}, \code{min_ma}), both of
which should be numeric.}

\item{min_ma}{\code{character}. The name of the column you wish to be treated as
the minimum ages in \code{occdf} and \code{bins} (defaults to "min_ma").}

\item{max_ma}{\code{character}. The name of the column you wish to be treated as
the maximum ages in \code{occdf} and \code{bins} (defaults to "max_ma").}

\item{bins}{\code{data.frame}. A \code{data.frame} of time bins used to look up
absolute stratigraphic ages for filtering fossil occurrences, such as that
returned by \code{\link[=time_bins]{time_bins()}}. This \code{data.frame} must contain at least
three columns as named by \code{interval_name} (defaults to "interval_name"),
\code{max_ma} (defaults to "max_ma") and \code{min_ma} (defaults to "min_ma"). Columns
\code{max_ma} and \code{min_ma} must be numeric.}

\item{interval_name}{\code{character} The name of the column in \code{bins} that
contains the interval names.}

\item{youngest_bin}{\code{character}. The name of the youngest stratigraphic
interval to trim to. Only one interval name should be supplied, which should
be present in column \code{interval_name} in \code{bins}.}

\item{oldest_bin}{\code{character}. The name of the oldest stratigraphic interval
to trim to. Only one interval name should be supplied, which should be
present in column \code{interval_name} in \code{bins}.}

\item{min_age}{\code{numeric}. The minimum absolute occurrence age to trim to.
Ignored if \code{youngest_bin} is supplied.}

\item{max_age}{\code{numeric}. The maximum absolute occurrence age to trim to.
Ignored if \code{oldest_bin} is supplied.}

\item{uncertainty}{A numeric value denoting the maximum tolerable temporal
uncertainty for retaining occurrences. Alternatively, if this argument is
set to "bins", then only occurrences which span no more than \code{n_bins}
intervals in \code{bins} will be retained.}

\item{n_bins}{\code{numeric} The maximum tolerable bin-wise uncertainty above
which occurrences will be discarded if \code{uncertainty = "bins"} (defaults
to \code{1}).}

\item{retain.taxa}{\code{logical}. Complete loss of some taxa may occur if all
their occurrences exceed the temporal uncertainty criterion set by the user.
If this is undesirable, occurrences for these taxa will be retained as
exceptions to the filtering parameters (defaults to \code{FALSE}).}

\item{taxa}{\code{character}. The name of the column in \code{occdf} you wish to be
treated as the taxon names in \code{occdf} if \code{retain.taxa = TRUE} (defaults to
\code{NULL}).}
}
\value{
The \code{data.frame} containing the original input \code{occdf}, minus any
occurrences discarded under the chosen trimming and filtering parameters. If
\code{retain.taxa = TRUE}, there will be an additional column called \code{retained},
consisting of \code{0} for occurrences which met the filtering criteria and \code{1}
for occurrences which were retained for taxonomic completeness. Depending on
the filtering parameters used, it is possible that all or no occurrences
will be discarded, resulting in an empty \code{data.frame} or an unchanged data
set respectively.
}
\description{
A function to trim fossil occurrences to within a specified temporal
duration and/or level of precision. Filtering can be performed using
stratigraphic interval names or absolute ages.
}
\details{
When trimming by stratigraphic interval names, the boundary ages of
\code{youngest_bin} and \code{oldest_bin} are taken from their entries in \code{bins}.
Occurrences with maximum ages younger than the upper boundary age of
\code{youngest_bin} or minimum ages older than the lower boundary age of
\code{oldest_bin} will be trimmed.

When filtering by temporal precision, if \code{uncertainty = "bins"}, the
function uses \code{\link[=bin_time]{bin_time()}} to assign occurrences to the
stratigraphic intervals present in \code{bins} and discards any which span more
than one interval, a common procedure in many computational palaeobiology
workflows.

Alternatively, trimming can be performed with absolute minimum and maximum
age ranges specified in \code{min_age} and \code{max_age}. Occurrences are then
discarded as for interval-derived upper and lower boundary ages. Similarly,
an absolute stratigraphic duration (e.g., \code{uncertainty = 12}) can be used to
filter to occurrences with age uncertainties lower than or equal to this
duration.

It is worth keeping in mind that occurrences which might overlap with your
specified time range but with either a minimum or maximum age outside of
this range will be excluded. Similarly, it is crucial that the
occurrence ages in your data and your trimming and filtering parameters
conform to the same stratigraphic timescale (e.g., GTS 2020) to avoid
incorrect exclusion of occurrences:
\itemize{
\item If interval boundary ages or absolute ages do not align precisely with
occurrence ages, this could result in substantial data loss towards the
stratigraphic upper and lower limits of the data during trimming, or during
filtering to single interval occurrences.
\item Similarly, filtering with an absolute value for temporal precision could
lead to loss of occurrences for entire stratigraphic intervals if that
value is shorter than the stratigraphic durations of those intervals.
\item Filtering to single interval occurrences may be preferable as this
accommodates variation in stratigraphic interval length through geological
time. If you choose to use an absolute duration, it may be advisable to take
a value no shorter than the longest interval duration present in your data
(e.g., the longest stage).
}

Finally, the function can retain occurrences (\code{retain.taxa = TRUE})
initially discarded when filtering by temporal uncertainty to ensure that
the taxonomic composition of the total data set is unchanged, whilst still
reducing temporal uncertainty elsewhere in the data:
\itemize{
\item Taxonomic retention is achieved by checking for any taxa that are lost
completely when filtering by temporal uncertainty, then reintroducing all
occurrences for those taxa. Such occurrences are marked within a column
appended to the returned data set.
\item Taxa lost during trimming to a particular stratigraphic duration are
not reintroduced in this way, nor are occurrences with missing entries in
the column specified by \code{taxa} (i.e., those with \code{NA} values).
\item This procedure may be convenient for downstream analyses where the taxa
present in a occurrence data set must match those in a different one (e.g.,
a phylogeny), but a user should carefully consider whether it is necessary
or reasonable to use poorer quality data analytically.
}
}
\section{Developer(s)}{
 Joseph T. Flannery-Sutherland
}

\section{Reviewer(s)}{
 William Gearty
}

\examples{
# get internal tetrapod data and GTS2020 stages
occdf <- tetrapods[1:100, ]
stages <- time_bins(rank = "stage")

# trim to Kungurian occurrences
filtered1 <- filter_time(occdf, min_age = 272.3, max_age = 279.3)

# trim to occurrences within the stages of the Permian
filtered2 <- filter_time(occdf, bins = stages,
                         youngest_bin = "Wuchiapingian", oldest_bin = "Asselian")

# filter to only occurrences which fall into single stages
filtered3 <- filter_time(occdf, bins = stages, uncertainty = "bins", n_bins = 1)

# filter to only Permian occurrences with age uncertainties less than or equal to 15 million years
filtered4 <- filter_time(occdf, bins = stages,
                         youngest_bin = "Wuchiapingian", oldest_bin = "Asselian",
                         uncertainty = 15)

# trim to occurrences within the stages of the Permian, and filter to those
# with age uncertainties less than or equal to 15 million years, but allow
# some less precise occurrences to remain to prevent loss of any taxa.
filtered5 <- filter_time(occdf, bins = stages,
                         youngest_bin = "Wuchiapingian", oldest_bin = "Asselian",
                         uncertainty = 20, retain.taxa = TRUE, taxa = "genus")

}
